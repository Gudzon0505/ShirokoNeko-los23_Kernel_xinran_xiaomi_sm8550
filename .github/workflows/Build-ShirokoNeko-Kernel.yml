
name: Build vermeer kernel (GKI, Lineage 23, KSU/SukiSU)

on:
  workflow_dispatch:
    inputs:
      root_solution:
        description: "Root solution"
        required: true
        type: choice
        default: "ksu"
        options:
          - "ksu"
          - "sukisu"

      sukisu_mode:
        description: "SukiSU mode (only if root_solution=sukisu)"
        required: true
        type: choice
        default: "susfs-main"
        options:
          - "main"
          - "nongki"
          - "susfs-main"

      defconfig:
        description: "Defconfig (leave empty for auto-detect)"
        required: false
        default: ""

      zip_suffix:
        description: "ZIP suffix (example: -GudzonKernel)"
        required: false
        default: "-GudzonKernel"

      upload_ccache_debug:
        description: "Upload ccache debug logs (usually not needed)"
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_COMPRESS: "true"
      CCACHE_MAXSIZE: "5G"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install dependencies
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget rsync zip unzip jq \
            build-essential bc bison flex make \
            libssl-dev libelf-dev zstd lz4 \
            python3 python3-pip \
            ccache clang lld llvm

      - name: Prepare ccache
        run: |
          set -eux
          ccache -M 5G
          ccache -z
          ccache -s

      - name: Integrate KernelSU (if selected)
        if: ${{ inputs.root_solution == 'ksu' }}
        run: |
          set -eux
          echo "KSU выбран. Если в репе уже есть KernelSU/патчи — просто продолжаем сборку."

      - name: Integrate SukiSU-Ultra (if selected)
        if: ${{ inputs.root_solution == 'sukisu' }}
        run: |
          set -eux
          # ОФИЦИАЛЬНЫЙ скрипт интеграции (важно: kernel/setup.sh, НЕ kernel/main/setup.sh)
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "${{ inputs.sukisu_mode }}"

      - name: Select defconfig (auto if empty)
        id: defc
        run: |
          set -eux
          DEF_IN="${{ inputs.defconfig }}"
          if [ -n "$DEF_IN" ]; then
            echo "defconfig=$DEF_IN" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Auto-detect defconfig..."

          # 1) Если есть gki_defconfig
          if [ -f "arch/arm64/configs/gki_defconfig" ]; then
            echo "defconfig=gki_defconfig" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2) Если есть vendor gki
          if [ -f "arch/arm64/configs/vendor/gki_defconfig" ]; then
            echo "defconfig=vendor/gki_defconfig" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 3) Пытаемся найти "vermeer" (часто так называют defconfig под device)
          CAND="$(ls -1 arch/arm64/configs/* 2>/dev/null | grep -i vermeer | head -n 1 || true)"
          if [ -n "$CAND" ]; then
            echo "defconfig=$(basename "$CAND")" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 4) Иначе берём первый попавшийся *_defconfig
          CAND2="$(ls -1 arch/arm64/configs/*defconfig 2>/dev/null | head -n 1 || true)"
          if [ -n "$CAND2" ]; then
            echo "defconfig=$(basename "$CAND2")" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ERROR: Не смог найти defconfig. Доступные configs:"
          ls -la arch/arm64/configs || true
          exit 1

      - name: Build kernel
        run: |
          set -eux
          DEF="${{ steps.defc.outputs.defconfig }}"
          echo "Using defconfig: $DEF"

          mkdir -p out
          export KBUILD_OUTPUT="$PWD/out"

          make O=out "$DEF"
          make -j"$(nproc)" O=out

          echo "Build finished."
          ls -la out/arch/arm64/boot || true

      - name: Pack AnyKernel3 (if present)
        run: |
          set -eux
          OUT="$PWD/out/arch/arm64/boot"
          if [ ! -f "$OUT/Image" ]; then
            echo "ERROR: out/arch/arm64/boot/Image not found"
            exit 1
          fi

          mkdir -p dist
          cp -v "$OUT/Image" "dist/Image${{ inputs.zip_suffix }}"

          # Если в репозитории есть папка AnyKernel3 — пакуем ZIP
          if [ -d "AnyKernel3" ]; then
            rm -rf AnyKernel3/.git || true
            cp -v "$OUT/Image" AnyKernel3/Image
            (cd AnyKernel3 && zip -r "../dist/AnyKernel3${{ inputs.zip_suffix }}.zip" .)
          else
            echo "AnyKernel3 folder not found — skipping zip."
          fi

      - name: ccache stats
        run: |
          ccache -s || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build${{ inputs.zip_suffix }}
          path: dist/*

      - name: Upload ccache debug logs (optional)
        if: ${{ inputs.upload_ccache_debug }}
        uses: actions/upload-artifact@v4
        with:
          name: ccache-debug${{ inputs.zip_suffix }}
          path: |
            ~/.cache/ccache/ccache.conf
            ~/.cache/ccache/ccache.log
