name: Build ShiroNeko Vermeer Kernel
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by Gemini
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install Compilers and Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential flex git libelf-dev libssl-dev python3 zip wget curl rsync lld-15 llvm-15 clang-15 dwarves
          
          # Создаем жесткие ссылки для всех инструментов LLVM
          mkdir -p $GITHUB_WORKSPACE/bin
          for tool in clang ld.lld llvm-nm llvm-ar llvm-objcopy llvm-objdump llvm-strip llvm-readelf llvm-size; do
            ln -sf /usr/bin/${tool}-15 $GITHUB_WORKSPACE/bin/${tool}
          done
          
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Build Kernel
        run: |
          export ARCH=arm64
          export PATH=$GITHUB_WORKSPACE/bin:$PATH
          
          # Применяем конфигурацию Poco F6 Pro
          make O=out Xinran_PocoF6Pro_defconfig
          
          # Принудительно отключаем BTF для обхода ошибки pahole
          scripts/config --file out/.config --disable CONFIG_DEBUG_INFO_BTF
          
          # Запуск сборки с использованием полной связки LLVM
          make -j$(nproc --all) O=out \
            CC=clang \
            LD=ld.lld \
            AR=llvm-ar \
            NM=llvm-nm \
            OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            READELF=llvm-readelf \
            OBJSIZE=llvm-size \
            LLVM=1 \
            LLVM_IAS=1 \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT=arm-linux-gnueabi-

      - name: Package AnyKernel3 (GKI Simple Flash)
        run: |
          mkdir -p output
          # Проверяем наличие ядра перед упаковкой
          if [ -f out/arch/arm64/boot/Image ]; then
            cp out/arch/arm64/boot/Image output/
          else
            echo "Ошибка: Файл Image не найден!"
            exit 1
          fi
          
          # Копируем базовую структуру AnyKernel3
          if [ -d "AnyKernel3" ]; then
            cp -r AnyKernel3/* output/
          fi

          # ПЕРЕЗАПИСЫВАЕМ СКРИПТ ДЛЯ ANDROID 16 (GKI FIX)
          cat <<'EOF' > output/anykernel.sh
          # AnyKernel3 Deployment Script
          properties() { '
          kernel.string=ShiroNeko Kernel for Poco F6 Pro (vermeer)
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          device.name1=vermeer
          supported.versions=13, 14, 15, 16
          '; }

          # Настройка для GKI устройств
          block=auto;
          is_slot_device=1;
          ramdisk_compression=auto;
          patch_vbmeta_flag=auto;

          . binary/utils.sh;

          # Метод прямой записи образа без распаковки ramdisk
          split_boot; 
          replace_kernel; 
          write_boot;
          EOF

          cd output
          zip -r9 ../ShiroNeko-Vermeer-A16-Ready.zip *

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: ShiroNeko-Vermeer-Kernel
          path: ShiroNeko-Vermeer-A16-Ready.zip

