name: Build ShiroNeko Vermeer Kernel
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by Gemini
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install Compilers and Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential flex git libelf-dev libssl-dev python3 zip wget curl rsync lld-15 llvm-15 clang-15 dwarves
          
          # Создаем бинарную директорию и жесткие ссылки
          mkdir -p $GITHUB_WORKSPACE/bin
          for tool in clang ld.lld llvm-nm llvm-ar llvm-objcopy llvm-objdump llvm-strip llvm-readelf; do
            ln -sf /usr/bin/${tool}-15 $GITHUB_WORKSPACE/bin/${tool}
          done
          
          # Добавляем в PATH
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Build Kernel
        run: |
          export ARCH=arm64
          export PATH=$GITHUB_WORKSPACE/bin:$PATH
          
          # Применяем конфиг
          make O=out Xinran_PocoF6Pro_defconfig
          
          # Отключаем BTF для стабильности
          scripts/config --file out/.config --disable CONFIG_DEBUG_INFO_BTF
          
          # Запуск сборки с принудительным указанием всех инструментов LLVM
          make -j$(nproc --all) O=out \
            CC=clang \
            LD=ld.lld \
            AR=llvm-ar \
            NM=llvm-nm \
            OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            READELF=llvm-readelf \
            LLVM=1 \
            LLVM_IAS=1 \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT=arm-linux-gnueabi-

      - name: Package AnyKernel3 (GKI Direct Flash Fix)
        run: |
          mkdir -p output
          cp out/arch/arm64/boot/Image output/
          
          # Копируем базовые файлы AnyKernel3 если они есть
          if [ -d "AnyKernel3" ]; then
            cp -r AnyKernel3/* output/
          fi

          # СОЗДАЕМ ИСПРАВЛЕННЫЙ СКРИПТ (Фикс "No ramdisk found")
          cat <<'EOF' > output/anykernel.sh
          # AnyKernel3 Deployment Script
          properties() { '
          kernel.string=ShiroNeko Kernel for Poco F6 Pro (vermeer)
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          do.cleancontainer=1
          device.name1=vermeer
          supported.versions=13, 14, 15, 16
          '; }

          # Настройка GKI: прошивка только Image в boot раздел
          block=auto;
          is_slot_device=1;
          ramdisk_compression=auto;
          patch_vbmeta_flag=auto;

          . binary/utils.sh;

          # ФИКС: Вместо распаковки (split_boot), сразу подменяем Image
          dump_boot; 
          write_boot;
          EOF

          cd output
          zip -r9 ../ShiroNeko-Vermeer-Ready.zip *

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ShiroNeko-Vermeer-Kernel
          path: ShiroNeko-Vermeer-Ready.zip

