name: Build vermeer kernel (GKI, Lineage 23, KSU/SukiSU)

on:
  workflow_dispatch:
    inputs:
      su_type:
        description: "Root solution"
        required: true
        default: "ksu"
        type: choice
        options:
          - ksu
          - sukisu
      defconfig:
        description: "Defconfig (оставь пустым для авто-подбора)"
        required: false
        default: ""
      kernel_suffix:
        description: "Kernel ZIP suffix (например: -GudzonKernel)"
        required: false
        default: "-GudzonKernel"
      upload_ccache_debug:
        description: "Upload ccache debug logs (обычно не нужно)"
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    env:
      ARCH: arm64
      SUBARCH: arm64
      LLVM: 1
      LLVM_IAS: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache curl flex git \
            libelf-dev libssl-dev lld llvm make python3 \
            rsync unzip zip zstd

      - name: Prepare ccache
        run: |
          set -eux
          ccache -M 5G || true
          ccache -z || true

      # ---------- Integrations ----------
      - name: Integrate KernelSU
        if: ${{ inputs.su_type == 'ksu' }}
        run: |
          set -eux
          echo "KernelSU integration: repo already contains KernelSU folder? If not - add your method here."
          # Если в репе уже есть KernelSU/ и патчи - обычно ничего делать не надо.
          # Если нужно подтягивать KernelSU как submodule/скриптом — добавим позже под твою структуру.

      - name: Integrate SukiSU-Ultra
        if: ${{ inputs.su_type == 'sukisu' }}
        run: |
          set -eux
          # официальный setup.sh из SukiSU-Ultra
          curl -L -o sukisu_setup.sh https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/main/setup.sh
          chmod +x sukisu_setup.sh
          # Запускаем без "susfs-main" (у тебя из-за этого и было pathspec error)
          ./sukisu_setup.sh

      # ---------- Defconfig selection ----------
      - name: Pick defconfig (auto if needed)
        id: defc
        run: |
          set -eux
          DEF="${{ inputs.defconfig }}"
          if [ -z "$DEF" ]; then
            # пробуем классический gki_defconfig
            if [ -f "arch/arm64/configs/gki_defconfig" ]; then
              DEF="gki_defconfig"
            else
              # ищем наиболее похожий
              DEF="$(find arch/arm64/configs -maxdepth 2 -type f -iname '*gki*defconfig*' | head -n 1 | sed 's#arch/arm64/configs/##')"
            fi
          fi

          if [ -z "$DEF" ]; then
            echo "ERROR: defconfig not found. Available configs:"
            ls -la arch/arm64/configs || true
            find arch/arm64/configs -maxdepth 2 -type f | sed 's#^# - #' || true
            exit 1
          fi

          echo "Using defconfig: $DEF"
          echo "defconfig=$DEF" >> "$GITHUB_OUTPUT"

      # ---------- Build ----------
      - name: Build kernel
        run: |
          set -eux
          OUT="$GITHUB_WORKSPACE/out"
          mkdir -p "$OUT"

          make O="$OUT" "${{ steps.defc.outputs.defconfig }}"
          # Можно добавить свои флаги/конфиги здесь при необходимости
          make -j"$(nproc)" O="$OUT"

          echo "Build done. Listing outputs:"
          ls -la "$OUT" || true

      # ---------- Package ----------
      - name: Package AnyKernel3 (if present)
        run: |
          set -eux
          OUT="$GITHUB_WORKSPACE/out"
          SUFFIX="${{ inputs.kernel_suffix }}"

          # Определяем Image
          IMG=""
          if [ -f "$OUT/arch/arm64/boot/Image" ]; then IMG="$OUT/arch/arm64/boot/Image"; fi
          if [ -f "$OUT/arch/arm64/boot/Image.gz" ]; then IMG="$OUT/arch/arm64/boot/Image.gz"; fi
          if [ -f "$OUT/arch/arm64/boot/Image.lz4" ]; then IMG="$OUT/arch/arm64/boot/Image.lz4"; fi

          if [ -z "$IMG" ]; then
            echo "ERROR: Kernel Image not found in out/arch/arm64/boot/"
            ls -la "$OUT/arch/arm64/boot" || true
            exit 1
          fi

          echo "Kernel image: $IMG"

          if [ -d "AnyKernel3" ]; then
            cp -f "$IMG" AnyKernel3/Image
            (cd AnyKernel3 && zip -r9 "../Kernel${SUFFIX}.zip" .)
            echo "Created: Kernel${SUFFIX}.zip"
          else
            echo "AnyKernel3 folder not found, skipping zip packaging."
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-${{ inputs.su_type }}
          path: |
            out/arch/arm64/boot/*
            Kernel*.zip
            AnyKernel3/Image
          if-no-files-found: warn

      - name: Upload ccache debug logs (optional)
        if: ${{ inputs.upload_ccache_debug == true }}
        uses: actions/upload-artifact@v4
        with:
          name: ccache-debug
          path: |
            ~/.cache/ccache/ccache.conf
            ~/.cache/ccache/*log*
          if-no-files-found: warn
