name: Build vermeer kernel (GKI, Lineage 23, KSU/SukiSU)

on:
  workflow_dispatch:
    inputs:
      root_solution:
        description: "Root solution"
        required: true
        type: choice
        default: "ksu"
        options:
          - "ksu"
          - "sukisu"

      sukisu_mode:
        description: "SukiSU mode (only if root_solution=sukisu)"
        required: true
        type: choice
        default: "susfs-main"
        options:
          - "main"
          - "nongki"
          - "susfs-main"

      defconfig:
        description: "Defconfig (leave empty for auto-detect)"
        required: false
        default: ""

      zip_suffix:
        description: "ZIP suffix"
        required: false
        default: "-GudzonKernel"

      upload_ccache_debug:
        description: "Upload ccache debug"
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # Extended for heavy build

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_COMPRESS: "true"
      CCACHE_MAXSIZE: "10G"  # Increased
      CROSS_COMPILE: aarch64-linux-gnu-
      CC: ccache clang
      LD: ccache ld.lld

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install dependencies
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget rsync zip unzip jq \
            build-essential bc bison flex make \
            libssl-dev libelf-dev zstd lz4 \
            python3 python3-pip \
            ccache clang lld llvm gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Prepare ccache
        run: |
          set -eux
          ccache -M 10G
          ccache -z
          ccache -s

      - name: Integrate KernelSU (if selected)
        if: ${{ inputs.root_solution == 'ksu' }}
        run: |
          set -eux
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

      - name: Integrate SukiSU-Ultra (if selected)
        if: ${{ inputs.root_solution == 'sukisu' }}
        run: |
          set -eux
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "${{ inputs.sukisu_mode }}"

      - name: Disable KVM (fix OOM)
        run: |
          set -eux
          sed -i 's/CONFIG_KVM=y/# CONFIG_KVM is not set/' arch/arm64/configs/*defconfig || true

      - name: Select defconfig
        id: defc
        run: |
          set -eux
          # (твой оригинальный код auto-detect, оставляем)

      - name: Build kernel (lower parallelism to avoid OOM)
        run: |
          set -eux
          DEF="${{ steps.defc.outputs.defconfig }}"
          echo "Using defconfig: $DEF"

          mkdir -p out
          export KBUILD_OUTPUT="$PWD/out"

          make O=out "$DEF"
          make -j8 O=out  # Reduced from $(nproc) to 8 — stable on runner

          echo "Build finished."
          ls -la out/arch/arm64/boot || true

      - name: Pack AnyKernel3
        run: |
          # (твой оригинальный код, но with -j8 fix)

      - name: ccache stats
        run: ccache -s

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build${{ inputs.zip_suffix }}
          path: dist/*

      - name: Upload ccache debug (optional)
        if: ${{ inputs.upload_ccache_debug }}
        uses: actions/upload-artifact@v4
        with:
          name: ccache-debug
          path: ~/.ccache/
