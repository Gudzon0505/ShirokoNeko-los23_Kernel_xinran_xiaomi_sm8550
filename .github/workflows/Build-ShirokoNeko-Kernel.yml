name: Build Vermeer Kernel (GKI, LOS23, SukiSU)

on:
  workflow_dispatch:
    inputs:
      root_solution:
        description: "Root solution"
        required: true
        default: "sukisu"
        type: choice
        options:
          - ksu
          - sukisu

      defconfig:
        description: "Defconfig (leave empty for auto)"
        required: false
        default: ""

      kernel_suffix:
        description: "ZIP suffix"
        required: false
        default: "-GudzonKernel"

      ccache_debug:
        description: "Upload ccache logs"
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    env:
      ARCH: arm64
      SUBARCH: arm64
      LLVM: 1
      CCACHE_COMPRESS: 1
      CCACHE_MAXSIZE: 5G

    steps:
      - name: Checkout kernel
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex git \
            libssl-dev libelf-dev lld llvm clang \
            python3 python-is-python3 zip unzip

      - name: Setup ccache
        run: |
          ccache -M 5G
          ccache -z

      - name: Integrate KernelSU (if selected)
        if: ${{ inputs.root_solution == 'ksu' }}
        run: |
          curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -

      - name: Integrate SukiSU-Ultra (FIXED)
        if: ${{ inputs.root_solution == 'sukisu' }}
        run: |
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU-Ultra.git sukisu
          cd sukisu/kernel
          bash setup.sh
          cd ../..
          git status

      - name: Select defconfig
        run: |
          if [ -n "${{ inputs.defconfig }}" ]; then
            export DEFCONFIG=${{ inputs.defconfig }}
          else
            export DEFCONFIG=gki_defconfig
          fi
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV

      - name: Build kernel
        run: |
          mkdir -p out
          make O=out $DEFCONFIG
          make -j$(nproc) O=out

      - name: Package AnyKernel3
        run: |
          if [ -d AnyKernel3 ]; then
            cp out/arch/arm64/boot/Image AnyKernel3/Image
            cd AnyKernel3
            zip -r ../Kernel${{ inputs.kernel_suffix }}.zip *
          fi

      - name: Upload kernel zip
        uses: actions/upload-artifact@v4
        with:
          name: Kernel${{ inputs.kernel_suffix }}
          path: |
            Kernel*.zip

      - name: Upload ccache logs (optional)
        if: ${{ inputs.ccache_debug }}
        uses: actions/upload-artifact@v4
        with:
          name: ccache-logs
          path: ~/.ccache
