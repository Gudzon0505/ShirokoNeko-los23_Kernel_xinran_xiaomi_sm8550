name: Build vermeer kernel (GKI, Lineage 23, KSU/SukiSU)

on:
  workflow_dispatch:
    inputs:
      root_solution:
        description: "Root solution"
        required: true
        type: choice
        default: "ksu"
        options:
          - "ksu"
          - "sukisu"

      sukisu_mode:
        description: "SukiSU mode (only if root_solution=sukisu)"
        required: true
        type: choice
        default: "susfs-main"
        options:
          - "main"
          - "nongki"
          - "susfs-main"

      defconfig:
        description: "Defconfig (leave empty for auto-detect)"
        required: false
        default: ""

      zip_suffix:
        description: "ZIP suffix (example: -GudzonKernel)"
        required: false
        default: "-GudzonKernel"

      upload_ccache_debug:
        description: "Upload ccache debug logs"
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # Дольше для тяжёлой сборки

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_COMPRESS: "true"
      CCACHE_MAXSIZE: "10G"  # Больше кэша
      CROSS_COMPILE: aarch64-linux-gnu-
      CC: ccache clang
      LD: ccache ld.lld

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install dependencies
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget rsync zip unzip jq \
            build-essential bc bison flex make \
            libssl-dev libelf-dev zstd lz4 \
            python3 python3-pip \
            ccache clang lld llvm gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Prepare ccache
        run: |
          set -eux
          ccache -M 10G
          ccache -z
          ccache -s

      - name: Integrate KernelSU (if selected)
        if: ${{ inputs.root_solution == 'ksu' }}
        run: |
          set -eux
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

      - name: Integrate SukiSU-Ultra (if selected)
        if: ${{ inputs.root_solution == 'sukisu' }}
        run: |
          set -eux
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "${{ inputs.sukisu_mode }}"

      - name: Disable KVM (экономия RAM, не нужен для телефона)
        run: |
          set -eux
          find arch/arm64/configs -type f -exec sed -i 's/^CONFIG_KVM=y/# CONFIG_KVM is not set/' {} +

      - name: Select defconfig (auto-detect + fallback)
        id: defc
        run: |
          set -eux
          DEF_IN="${{ inputs.defconfig }}"
          if [ -n "$DEF_IN" ]; then
            echo "defconfig=$DEF_IN" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Auto-detect defconfig..."

          CAND=""
          if [ -f "arch/arm64/configs/gki_defconfig" ]; then
            CAND="gki_defconfig"
          elif [ -f "arch/arm64/configs/vendor/gki_defconfig" ]; then
            CAND="vendor/gki_defconfig"
          else
            CAND="$(ls -1 arch/arm64/configs/* 2>/dev/null | grep -i vermeer | head -n 1 || true)"
            if [ -n "$CAND" ]; then
              CAND="$(basename "$CAND")"
            fi
          fi

          if [ -z "$CAND" ]; then
            CAND="$(ls -1 arch/arm64/configs/*defconfig 2>/dev/null | head -n 1 || true)"
            if [ -n "$CAND" ]; then
              CAND="$(basename "$CAND")"
            fi
          fi

          if [ -z "$CAND" ]; then
            echo "ERROR: No defconfig found!"
            ls -la arch/arm64/configs || true
            exit 1
          fi

          echo "defconfig=$CAND" >> $GITHUB_OUTPUT

      - name: Build kernel (low parallelism to avoid OOM)
        run: |
          set -eux
          DEF="${{ steps.defc.outputs.defconfig }}"
          echo "Using defconfig: $DEF"

          mkdir -p out
          export KBUILD_OUTPUT="$PWD/out"

          make O=out "$DEF"
          make -j8 O=out  # 8 потоков — стабильно на runner, без OOM

          echo "Build finished."
          ls -la out/arch/arm64/boot || true

      - name: Pack AnyKernel3 (if present)
        run: |
          set -eux
          OUT="$PWD/out/arch/arm64/boot"
          if [ ! -f "$OUT/Image" ]; then
            echo "ERROR: Image not found!"
            exit 1
          fi

          mkdir -p dist
          cp -v "\( OUT/Image" "dist/Image \){{ inputs.zip_suffix }}"

          if [ -d "AnyKernel3" ]; then
            rm -rf AnyKernel3/.git || true
            cp -v "$OUT/Image" AnyKernel3/Image
            (cd AnyKernel3 && zip -r "../dist/AnyKernel3${{ inputs.zip_suffix }}.zip" .)
          else
            echo "AnyKernel3 not found — only Image uploaded."
          fi

      - name: ccache stats
        run: ccache -s || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build${{ inputs.zip_suffix }}
          path: dist/*

      - name: Upload ccache debug (optional)
        if: ${{ inputs.upload_ccache_debug }}
        uses: actions/upload-artifact@v4
        with:
          name: ccache-debug${{ inputs.zip_suffix }}
          path: ~/.ccache/
